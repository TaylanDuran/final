<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Destek Durumu | Zylfit PT</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <header class="bg-white shadow mb-6">
      <div class="max-w-7xl mx-auto px-4 py-6 flex items-center justify-between">
        <a href="/" class="flex items-center text-xl font-bold text-indigo-600">
          <img src="/img/logo.png" alt="Zylfit" class="h-8 w-auto mr-2" />
          <span>Zylfit</span>
        </a>
        <nav class="space-x-4 hidden md:flex">
          <a href="/" class="hover:text-indigo-600">Ana Sayfa</a>
          <a href="/packages.html" class="hover:text-indigo-600">Paketler</a>
          <a href="/recipes.html" class="hover:text-indigo-600">Tarifler</a>
          <a href="/support.html" class="hover:text-indigo-600">Destek</a>
          <a href="/status.html" class="hover:text-indigo-600">Destek Durumu</a>
        </nav>
        <button id="mobileMenuButton" class="md:hidden text-gray-500 focus:outline-none">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
      <div id="mobileMenu" class="md:hidden hidden px-4 pb-4 space-y-2">
        <a href="/" class="block">Ana Sayfa</a>
        <a href="/packages.html" class="block">Paketler</a>
        <a href="/recipes.html" class="block">Tarifler</a>
        <a href="/support.html" class="block">Destek</a>
        <a href="/status.html" class="block">Destek Durumu</a>
      </div>
    </header>
    <main class="w-full max-w-4xl mx-auto px-4 pb-16">
      <h1 class="text-3xl font-bold mb-6 text-center">Destek Durumu</h1>
      <div id="loginSection" class="bg-white p-6 rounded-lg shadow">
        <p class="mb-4">Destek talebinizi görmek için e‑posta ve şifrenizi girin:</p>
        <form id="checkForm" class="space-y-4">
          <div>
            <label for="email" class="block mb-1 font-medium">E‑posta</label>
            <input type="email" id="email" class="w-full px-3 py-2 border rounded" required />
          </div>
          <div>
            <label for="password" class="block mb-1 font-medium">Şifre</label>
            <input type="password" id="password" class="w-full px-3 py-2 border rounded" required />
          </div>
          <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 transition">Görüntüle</button>
        </form>
      </div>
      <div id="ticketSection" class="hidden bg-white p-6 rounded-lg shadow">
        <h2 id="ticketTitle" class="text-xl font-semibold mb-4"></h2>
        <div id="messages" class="h-80 md:h-96 overflow-y-auto mb-4 space-y-2 p-2 border rounded bg-gray-50"></div>
        <form id="clientMessageForm" class="flex space-x-2">
          <input type="text" id="clientMessageInput" class="flex-1 px-3 py-2 border rounded" placeholder="Yanıt yazın..." />
          <input type="file" id="clientFileInput" class="flex-none" />
          <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">Gönder</button>
        </form>
      </div>
    </main>
    <script>
      document.getElementById('mobileMenuButton').addEventListener('click', () => {
        document.getElementById('mobileMenu').classList.toggle('hidden');
      });
      let ticketId = null;
      let ticketEmail = '';
      let ticketStatus = 'open';
      document.getElementById('checkForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const res = await fetch(`/api/user/ticket?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`);
        if (res.ok) {
          const ticket = await res.json();
          ticketId = ticket.id;
          ticketEmail = ticket.email;
          ticketStatus = ticket.status || 'open';
          document.getElementById('ticketTitle').textContent = `Talep: ${ticket.email}`;
          renderMessages(ticket.messages);
          updateFormState();
          document.getElementById('loginSection').classList.add('hidden');
          document.getElementById('ticketSection').classList.remove('hidden');
        } else {
          alert('Talep bulunamadı. Bilgilerinizi kontrol edin.');
        }
      });
      function renderMessages(list) {
        const container = document.getElementById('messages');
        container.innerHTML = '';
        list.forEach(msg => {
          appendMessage(msg);
        });
        container.scrollTop = container.scrollHeight;
      }
      function appendMessage(msg) {
        const { sender, text, time, attachment } = msg;
        const container = document.getElementById('messages');
        const wrapper = document.createElement('div');
        wrapper.classList.add('flex');
        wrapper.classList.add(sender === 'admin' ? 'justify-start' : 'justify-end');
        const bubble = document.createElement('div');
        bubble.classList.add('p-3', 'rounded-lg', 'max-w-xs', 'shadow', 'whitespace-pre-wrap');
        if (sender === 'admin') {
          bubble.classList.add('bg-gray-200', 'text-gray-800');
        } else {
          bubble.classList.add('bg-indigo-600', 'text-white');
        }
        let inner = '';
        if (text) inner += `<p>${text}</p>`;
        if (attachment) {
          const lower = attachment.toLowerCase();
          if (lower.match(/\.(png|jpg|jpeg|gif)$/)) {
            inner += `<img src="${attachment}" alt="Ek" class="mt-2 max-w-full h-auto rounded">`;
          } else {
            const fileName = attachment.split('/').pop();
            inner += `<a href="${attachment}" target="_blank" class="mt-2 text-blue-200 underline block">${fileName}</a>`;
          }
        }
        inner += `<span class="block mt-1 text-xs opacity-70">${new Date(time).toLocaleTimeString('tr-TR', { hour:'2-digit', minute:'2-digit' })}</span>`;
        bubble.innerHTML = inner;
        wrapper.appendChild(bubble);
        container.appendChild(wrapper);
      }
      document.getElementById('clientMessageForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!ticketId) return;
        const inputEl = document.getElementById('clientMessageInput');
        const fileEl = document.getElementById('clientFileInput');
        const text = inputEl.value.trim();
        const file = fileEl.files[0];
        let payload = { sender: 'client' };
        if (text) payload.text = text;
        if (file) {
          payload.fileName = file.name;
          payload.file = await fileToDataUri(file);
        }
        if (!payload.text && !payload.file) return;
        const res = await fetch(`/api/tickets/${ticketId}/message`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (res.ok) {
          const now = new Date().toISOString();
          const msg = { sender: 'client', time: now };
          if (text) msg.text = text;
          if (payload.file) {
            // actual attachment path will be returned on next poll
          }
          appendMessage(msg);
          inputEl.value = '';
          fileEl.value = '';
        }
      });

      function updateFormState() {
        const formEl = document.getElementById('clientMessageForm');
        if (ticketStatus === 'closed') {
          formEl.classList.add('hidden');
        } else {
          formEl.classList.remove('hidden');
        }
      }

      function fileToDataUri(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = err => reject(err);
          reader.readAsDataURL(file);
        });
      }
      // poll for new messages every 15 seconds
      setInterval(async () => {
        if (ticketId) {
          const res = await fetch(`/api/tickets/${ticketId}`);
          if (res.ok) {
            const ticket = await res.json();
            renderMessages(ticket.messages);
            // update status and form visibility
            ticketStatus = ticket.status || 'open';
            updateFormState();
          }
        }
      }, 15000);
    </script>
  </body>
</html>